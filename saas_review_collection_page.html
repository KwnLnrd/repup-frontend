<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donnez votre avis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand-color: #34D399;
            --brand-color-dark: #2AA77E;
            --brand-text-on-accent: #1A202C;
            --background-color: #F7FAFC;
            --surface-color: #FFFFFF;
            --text-primary: #1A202C;
            --text-secondary: #718096;
            --border-color: #E2E8F0;
            --font-display: 'Manrope', sans-serif;
            --font-sans: 'Inter', sans-serif;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 50% { opacity: .5; } }
        @keyframes confetti-fall {
            0% { transform: translateY(-100%) rotateZ(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotateZ(720deg); opacity: 0; }
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--background-color);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .review-container {
            width: 100%;
            max-width: 560px;
            margin: 2rem auto;
        }
        .review-card {
            background-color: var(--surface-color);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05), 0 10px 10px -5px rgba(0,0,0,0.04);
            border: 1px solid var(--border-color);
            animation: fadeIn .8s ease-out forwards;
            margin-bottom: 1.5rem;
        }
        h1, h2 { font-family: var(--font-display); font-weight: 800; }
        .skeleton { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; background-color: #e2e8f0; border-radius: 0.5rem; }
        
        /* Star Rating */
        .star-rating { display: flex; justify-content: center; gap: 0.5rem; }
        .star-rating svg { width: 40px; height: 40px; color: #CBD5E0; cursor: pointer; transition: all 0.2s; }
        .star-rating:hover svg { color: #FBBF24; }
        .star-rating svg:hover ~ svg { color: #CBD5E0; }
        .star-rating.selected svg { color: #FBBF24; }
        
        /* Tag Selection */
        .tag {
            background-color: #F7FAFC; color: var(--text-secondary);
            padding: 0.5rem 1rem; border-radius: 9999px; cursor: pointer;
            font-size: .9rem; font-weight: 500; transition: all .2s ease;
            border: 1px solid var(--border-color); user-select: none;
        }
        .tag.selected {
            background-color: var(--brand-color); color: var(--brand-text-on-accent); border-color: var(--brand-color);
            font-weight: 600;
        }

        /* Typing animation */
        #review-text-output { white-space: pre-wrap; }
        .typing-cursor {
            display: inline-block;
            width: 8px; height: 1.2em;
            background-color: var(--text-primary);
            animation: pulse 1s infinite;
            margin-left: 2px;
        }
    </style>
</head>
<body class="p-4">

    <div id="review-container" class="review-container">

        <!-- Skeleton Loader -->
        <div id="loader" class="review-card">
            <div class="skeleton h-16 w-32 mx-auto mb-6"></div>
            <div class="skeleton h-8 w-3/4 mx-auto mb-4"></div>
            <div class="skeleton h-12 w-full mx-auto mb-8"></div>
            <div class="skeleton h-6 w-1/2 mx-auto"></div>
        </div>

        <!-- Main App Content -->
        <div id="app-content" class="hidden">
            
            <!-- Card 1: Initial Rating -->
            <div id="rating-card" class="review-card text-center">
                <div id="logo-container" class="mb-6 flex justify-center items-center h-16"></div>
                <h1 id="restaurant-name-title" class="text-3xl"></h1>
                <p class="text-lg text-gray-500 mt-2 mb-6">Comment s'est passée votre expérience ?</p>
                <div id="star-rating" class="star-rating">
                    <!-- Stars will be injected by JS -->
                </div>
            </div>

            <!-- Content revealed after rating -->
            <div id="follow-up-content" class="hidden space-y-6">

                <!-- Card 2: Positive Flow -->
                <div id="positive-flow-card" class="review-card hidden">
                    <h2 class="text-2xl text-center mb-6">Génial ! Aidez-nous à partager votre enthousiasme.</h2>
                    
                    <!-- Server Selection -->
                    <div id="server-section" class="mb-8">
                        <label class="font-semibold text-center block mb-4">Qui s'est occupé de vous ? (optionnel)</label>
                        <div id="server-grid" class="grid grid-cols-3 sm:grid-cols-4 gap-4"></div>
                    </div>

                    <!-- Tags Selection -->
                    <div id="tags-section" class="mb-8">
                        <label class="font-semibold text-center block mb-4">Qu'avez-vous particulièrement apprécié ?</label>
                        <div id="tags-grid" class="flex flex-wrap justify-center gap-3"></div>
                    </div>

                    <!-- Review Generation -->
                    <div class="text-center">
                         <button id="generate-review-btn" class="w-full md:w-auto bg-brand-color text-brand-text-on-accent font-bold px-8 py-4 rounded-lg hover:bg-brand-color-dark transition-transform hover:scale-105">
                            Générer mon avis personnalisé
                        </button>
                    </div>
                </div>

                <!-- Card 3: AI Review Display -->
                <div id="review-output-card" class="review-card hidden">
                    <h2 class="text-2xl text-center mb-4">Votre avis est prêt !</h2>
                    <div class="bg-gray-50 p-4 rounded-lg border min-h-[150px]">
                        <p id="review-text-output" class="text-gray-700"></p>
                    </div>
                    <div class="flex items-center justify-between mt-4">
                        <button id="regenerate-btn" class="text-sm text-gray-500 hover:text-black">Générer une autre version</button>
                        <button id="copy-btn" class="bg-gray-200 text-gray-800 font-semibold px-4 py-2 rounded-lg hover:bg-gray-300">Copier</button>
                    </div>
                    <div id="publish-buttons" class="mt-6 space-y-3">
                        <!-- Publish buttons injected here -->
                    </div>
                </div>

                <!-- Card 4: Negative Flow -->
                <div id="negative-flow-card" class="review-card hidden">
                    <h2 class="text-2xl text-center">Nous sommes sincèrement désolés.</h2>
                    <p class="text-center text-gray-600 mt-2 mb-6">Vos retours sont essentiels pour nous améliorer. Veuillez nous laisser un message privé.</p>
                    <textarea id="private-feedback-textarea" rows="5" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-color focus:outline-none" placeholder="Décrivez votre expérience..."></textarea>
                    <button id="send-feedback-btn" class="mt-4 w-full bg-brand-color text-brand-text-on-accent font-bold px-8 py-3 rounded-lg hover:bg-brand-color-dark">
                        Envoyer à l'équipe
                    </button>
                </div>

                 <!-- Card 5: Thank You Message -->
                <div id="thank-you-card" class="review-card hidden text-center">
                    <h2 class="text-2xl">Merci !</h2>
                    <p class="text-gray-600 mt-2">Votre message a bien été transmis à l'équipe du restaurant. Nous apprécions votre aide.</p>
                </div>

            </div>
        </div>
    </div>
    <div id="confetti-container" class="fixed top-0 left-0 w-full h-full pointer-events-none overflow-hidden z-50"></div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIG & STATE ---
        const API_BASE_URL = 'https://repup-test.onrender.com';
        const state = {
            restaurant: null,
            rating: 0,
            selectedServer: null,
            selectedTags: [],
            isGenerating: false,
        };

        // --- DOM ELEMENTS ---
        const loader = document.getElementById('loader');
        const appContent = document.getElementById('app-content');
        const logoContainer = document.getElementById('logo-container');
        const restaurantNameTitle = document.getElementById('restaurant-name-title');
        const starRatingContainer = document.getElementById('star-rating');
        const followUpContent = document.getElementById('follow-up-content');
        
        const positiveFlowCard = document.getElementById('positive-flow-card');
        const serverSection = document.getElementById('server-section');
        const serverGrid = document.getElementById('server-grid');
        const tagsSection = document.getElementById('tags-section');
        const tagsGrid = document.getElementById('tags-grid');
        const generateBtn = document.getElementById('generate-review-btn');
        
        const reviewOutputCard = document.getElementById('review-output-card');
        const reviewTextOutput = document.getElementById('review-text-output');
        const regenerateBtn = document.getElementById('regenerate-btn');
        const copyBtn = document.getElementById('copy-btn');
        const publishButtons = document.getElementById('publish-buttons');

        const negativeFlowCard = document.getElementById('negative-flow-card');
        const sendFeedbackBtn = document.getElementById('send-feedback-btn');

        const thankYouCard = document.getElementById('thank-you-card');

        // --- API & DATA HANDLING ---
        async function fetchRestaurantData() {
            try {
                const slug = new URLSearchParams(window.location.search).get('slug');
                if (!slug) throw new Error("Restaurant non identifié.");
                
                const response = await fetch(`${API_BASE_URL}/api/public/restaurant/${slug}`);
                if (!response.ok) throw new Error(`Erreur de chargement (code: ${response.status})`);
                
                state.restaurant = await response.json();
                return true;
            } catch (error) {
                loader.innerHTML = `<p class="text-red-500 font-semibold text-center">${error.message}</p>`;
                return false;
            }
        }

        // --- UI RENDERING & ANIMATIONS ---
        function applyBranding() {
            const root = document.documentElement;
            const color = state.restaurant.primaryColor || '#34D399';
            root.style.setProperty('--brand-color', color);
            const [r, g, b] = color.match(/\w\w/g).map((c) => parseInt(c, 16));
            root.style.setProperty('--brand-color-dark', `rgb(${Math.max(0, r-20)}, ${Math.max(0, g-20)}, ${Math.max(0, b-20)})`);
            
            const logoUrl = state.restaurant.logoUrl 
                ? `${API_BASE_URL}${state.restaurant.logoUrl}` 
                : `https://placehold.co/200x60/${color.substring(1)}/FFFFFF?text=${encodeURIComponent(state.restaurant.name)}`;
            logoContainer.innerHTML = `<img src="${logoUrl}" alt="Logo de ${state.restaurant.name}" class="max-h-16 object-contain">`;
            restaurantNameTitle.textContent = `chez ${state.restaurant.name}`;
        }
        
        function createStars() {
            for (let i = 1; i <= 5; i++) {
                const star = document.createElement('div');
                star.dataset.value = i;
                star.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>`;
                starRatingContainer.appendChild(star);
            }
        }

        function updateStarDisplay(rating) {
            const stars = starRatingContainer.querySelectorAll('div > svg');
            stars.forEach((star, index) => {
                star.style.color = index < rating ? '#FBBF24' : '#CBD5E0';
            });
        }

        function triggerConfetti() {
            const container = document.getElementById('confetti-container');
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'absolute';
                confetti.style.width = `${Math.random() * 10 + 5}px`;
                confetti.style.height = confetti.style.width;
                confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 90%, 70%)`;
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.animation = `confetti-fall ${Math.random() * 3 + 2}s linear ${Math.random() * 2}s forwards`;
                container.appendChild(confetti);
                setTimeout(() => confetti.remove(), 5000);
            }
        }
        
        function typeAnimation(element, text, onComplete) {
            element.innerHTML = '';
            let i = 0;
            const cursor = document.createElement('span');
            cursor.className = 'typing-cursor';
            element.appendChild(cursor);

            const typingInterval = setInterval(() => {
                if (i < text.length) {
                    element.insertBefore(document.createTextNode(text.charAt(i)), cursor);
                    i++;
                } else {
                    clearInterval(typingInterval);
                    cursor.remove();
                    if(onComplete) onComplete();
                }
            }, 30);
        }
        
        function populateFollowUpContent() {
            // Servers
            if (state.restaurant.servers && state.restaurant.servers.length > 0) {
                serverGrid.innerHTML = state.restaurant.servers.map(server => {
                    const avatarSrc = server.avatar 
                        ? `${API_BASE_URL}${server.avatar}` 
                        : `https://ui-avatars.com/api/?name=${encodeURIComponent(server.name)}&background=e2e8f0&color=2d3748`;
                    return `
                        <div data-server-name="${server.name}" class="tag flex flex-col items-center gap-2 p-3 h-auto rounded-xl">
                            <img src="${avatarSrc}" alt="${server.name}" class="w-16 h-16 rounded-full object-cover">
                            <span class="font-semibold">${server.name}</span>
                        </div>`;
                }).join('');
                serverSection.classList.remove('hidden');
            } else {
                serverSection.classList.add('hidden');
            }

            // Tags
            const allTags = [
                ...(state.restaurant.tags?.service || []),
                ...(state.restaurant.tags?.atmosphere || []),
                ...(state.restaurant.tags?.occasion || [])
            ];
            if(allTags.length > 0) {
                tagsGrid.innerHTML = allTags.map(tag => `<div class="tag" data-tag-text="${tag.text}">${tag.text}</div>`).join('');
                tagsSection.classList.remove('hidden');
            } else {
                tagsSection.classList.add('hidden');
            }

            // Publish buttons
            publishButtons.innerHTML = '';
            if (state.restaurant.links?.google) {
                publishButtons.innerHTML += `<a href="${state.restaurant.links.google}" target="_blank" class="block w-full text-center bg-blue-500 text-white font-bold px-6 py-3 rounded-lg hover:bg-blue-600">Publier sur Google</a>`;
            }
            if (state.restaurant.links?.tripadvisor) {
                publishButtons.innerHTML += `<a href="${state.restaurant.links.tripadvisor}" target="_blank" class="block w-full text-center bg-green-600 text-white font-bold px-6 py-3 rounded-lg hover:bg-green-700">Publier sur TripAdvisor</a>`;
            }
        }

        // --- LOGIC & FLOW ---
        function handleRatingSelection(rating) {
            if (state.rating !== 0) return; // Prevent re-triggering
            state.rating = rating;
            starRatingContainer.classList.add('selected', 'pointer-events-none');
            updateStarDisplay(rating);
            
            followUpContent.classList.remove('hidden');

            if (rating > 3) {
                triggerConfetti();
                positiveFlowCard.classList.remove('hidden');
            } else {
                negativeFlowCard.classList.remove('hidden');
            }
        }
        
        async function handleGenerateReview() {
            if (state.isGenerating) return;
            state.isGenerating = true;
            
            positiveFlowCard.classList.add('hidden');
            reviewOutputCard.classList.remove('hidden');
            reviewTextOutput.innerHTML = '<span class="typing-cursor"></span>';
            regenerateBtn.disabled = true;
            copyBtn.disabled = true;

            const prompt = `Rédige un avis de restaurant 5 étoiles court et enthousiaste pour "${state.restaurant.name}".
                Note donnée : ${state.rating} sur 5.
                ${state.selectedServer ? `Le service a été fait par ${state.selectedServer}.` : ''}
                ${state.selectedTags.length > 0 ? `Points particulièrement appréciés : ${state.selectedTags.join(', ')}.` : ''}
                Le ton doit être authentique et personnel. Termine par une recommandation forte. Langue: Français.`;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/generate-review`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || "Erreur de l'API");
                
                typeAnimation(reviewTextOutput, result.review, () => {
                    state.isGenerating = false;
                    regenerateBtn.disabled = false;
                    copyBtn.disabled = false;
                });

            } catch (error) {
                reviewTextOutput.textContent = `Erreur: ${error.message}`;
                state.isGenerating = false;
            }
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            starRatingContainer.addEventListener('mouseover', e => {
                const starDiv = e.target.closest('div[data-value]');
                if (starDiv) updateStarDisplay(starDiv.dataset.value);
            });
            starRatingContainer.addEventListener('mouseout', () => updateStarDisplay(0));
            starRatingContainer.addEventListener('click', e => {
                const starDiv = e.target.closest('div[data-value]');
                if (starDiv) handleRatingSelection(parseInt(starDiv.dataset.value));
            });

            serverGrid.addEventListener('click', e => {
                const serverTag = e.target.closest('.tag');
                if (serverTag) {
                    const selected = serverGrid.querySelector('.selected');
                    if (selected) selected.classList.remove('selected');
                    serverTag.classList.add('selected');
                    state.selectedServer = serverTag.dataset.serverName;
                }
            });

            tagsGrid.addEventListener('click', e => {
                const tag = e.target.closest('.tag');
                if (tag) {
                    tag.classList.toggle('selected');
                    state.selectedTags = Array.from(tagsGrid.querySelectorAll('.selected')).map(t => t.dataset.tagText);
                }
            });

            generateBtn.addEventListener('click', handleGenerateReview);
            regenerateBtn.addEventListener('click', handleGenerateReview);
            
            copyBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(reviewTextOutput.textContent);
                copyBtn.textContent = 'Copié !';
                setTimeout(() => { copyBtn.textContent = 'Copier'; }, 2000);
            });

            sendFeedbackBtn.addEventListener('click', () => {
                negativeFlowCard.classList.add('hidden');
                thankYouCard.classList.remove('hidden');
                // Here you would typically send the feedback to your backend
                console.log('Feedback à envoyer:', document.getElementById('private-feedback-textarea').value);
            });
        }

        // --- INITIALIZATION ---
        async function init() {
            const success = await fetchRestaurantData();
            if (success) {
                loader.classList.add('hidden');
                appContent.classList.remove('hidden');
                applyBranding();
                createStars();
                populateFollowUpContent();
                setupEventListeners();
            }
        }

        init();
    });
    </script>
</body>
</html>
