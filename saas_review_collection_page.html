<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donnez votre avis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* --- DESIGN SYSTEM (Inspiré de indexmodel.html) --- */
        :root {
            --brand-color: #BF5B3F; /* Sera surchargé par JS */
            --brand-color-light: rgba(191, 91, 63, 0.1);
            --brand-color-dark: #A64B35;
            --background-color: #F8F9FA;
            --surface-color: #FFFFFF;
            --text-primary: #212529;
            --text-secondary: #6C757D;
            --border-color: #DEE2E6;
            --font-serif: 'Cormorant Garamond', serif;
            --font-sans: 'Montserrat', sans-serif;
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -1px rgba(0,0,0,.06);
        }

        /* --- STYLES GLOBAUX --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        body {
            font-family: var(--font-sans);
            background-color: var(--background-color);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .review-container {
            background-color: var(--surface-color);
            border-radius: 12px;
            padding: 28px 32px;
            box-shadow: var(--shadow-md);
            width: 100%;
            max-width: 520px;
            text-align: center;
            border: 1px solid var(--border-color);
            animation: fadeIn .8s ease-out;
            margin: 20px 0;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .review-container.loaded {
            opacity: 1;
        }

        .logo-container { margin-bottom: 24px; }
        .logo-container img { max-height: 60px; height: auto; margin: 0 auto; object-fit: contain; }
        
        h1 { font-family: var(--font-serif); font-size: 2rem; margin-bottom: 8px; }
        p.subtitle { font-size: 1rem; line-height: 1.6; color: var(--text-secondary); margin-bottom: 28px; }
        
        /* --- SECTIONS DE FORMULAIRE --- */
        .form-section { display: none; animation: fadeIn 0.6s ease-out; }
        .form-section.active { display: block; }
        .form-section h2 { font-family: var(--font-serif); font-size: 1.5rem; margin-bottom: 12px; color: var(--text-primary); }

        /* --- GRILLE DE SÉLECTION (Serveurs) --- */
        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .selection-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .selection-item.selected {
            border-color: var(--brand-color);
            background-color: var(--brand-color-light);
            box-shadow: 0 0 0 2px var(--brand-color);
        }
        .selection-item img {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 0.75rem;
            background-color: #f0f0f0;
        }
        .selection-item span {
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        /* --- ÉVALUATION PAR ÉTOILES --- */
        .star-rating {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            margin: 1.5rem 0;
        }
        .star-rating svg {
            width: 3rem;
            height: 3rem;
            color: #E0E0E0;
            cursor: pointer;
            transition: all 0.2s;
        }
        .star-rating svg.selected {
            color: #FFC107;
        }
        .star-rating:hover svg:hover,
        .star-rating:hover svg:hover ~ svg {
             color: #E0E0E0;
        }
        .star-rating:hover svg:hover {
            color: #FFD700;
            transform: scale(1.15);
        }
        #rating-feedback {
            min-height: 28px;
            font-weight: 600;
            font-size: 1.25rem;
            color: var(--brand-color);
            margin-top: 1rem;
        }

        /* --- FORMULAIRES & BOUTONS --- */
        textarea {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--surface-color);
            font-family: var(--font-sans);
            font-size: 1rem;
            color: var(--text-primary);
            box-sizing: border-box;
            min-height: 120px;
            resize: vertical;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        textarea:focus {
            outline: none; border-color: var(--brand-color);
            box-shadow: 0 0 0 3px rgba(191, 91, 63, 0.2);
        }

        .button {
            display: inline-block;
            background-color: var(--brand-color);
            color: #fff;
            border: none;
            padding: 14px 28px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all .3s ease;
            text-decoration: none;
            box-sizing: border-box;
        }
        .button:hover {
            background-color: var(--brand-color-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .button.secondary {
            background: var(--surface-color);
            color: var(--brand-color);
            border: 1px solid var(--brand-color);
        }
        .button.secondary:hover {
            background-color: var(--brand-color-light);
            border-color: var(--brand-color);
        }
        
        .language-switcher { margin-bottom: 24px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .lang-btn { background-color: var(--background-color); border: 1px solid var(--border-color); padding: 8px 14px; border-radius: 50px; cursor: pointer; font-weight: 500; transition: all 0.2s; }
        .lang-btn.active { background-color: var(--brand-color); color: white; border-color: var(--brand-color); }
        
        #loader { text-align: center; padding: 3rem; }
        #thank-you-message svg { width: 4rem; height: 4rem; margin: 0 auto 1rem; color: #28a745; }

        @media (max-width: 600px) {
            body { padding: 10px; }
            .review-container { padding: 20px 15px; margin: 10px 0; }
            h1 { font-size: 1.8rem; }
            .selection-grid { gap: 0.75rem; }
        }
    </style>
</head>
<body>

    <div id="review-container" class="review-container">
        <div id="loader">
            <p data-translate-key="loading_restaurant">Chargement des informations...</p>
        </div>
        
        <div id="app-content" class="hidden">
            <!-- Header: Logo & Language Switcher -->
            <div id="lang-container" class="language-switcher"></div>
            <div class="logo-container" id="logo-container"></div>

            <!-- Step 0: Language Selection (if more than one) -->
            <div id="section-lang" class="form-section">
                 <h1 data-translate-key="choose_language_title">Choose your language</h1>
                 <div id="lang-selector" class="flex flex-wrap justify-center gap-3 mt-6"></div>
            </div>

            <!-- Step 1: Server Selection -->
            <div id="section-server" class="form-section">
                <h1 id="server-title"></h1>
                <p id="server-subtitle" class="subtitle"></p>
                <div id="server-grid" class="selection-grid"></div>
            </div>

            <!-- Step 2: Rating -->
            <div id="section-rating" class="form-section">
                <h1 id="rating-title"></h1>
                <p id="rating-subtitle" class="subtitle"></p>
                <div id="star-rating" class="star-rating"></div>
                <p id="rating-feedback"></p>
            </div>
            
            <!-- Step 3: Positive Feedback -->
            <div id="section-positive-feedback" class="form-section">
                <h1 id="positive-title"></h1>
                <p id="positive-subtitle" class="subtitle"></p>
                <div id="positive-buttons" class="space-y-4"></div>
            </div>

            <!-- Step 4: Negative Feedback -->
            <div id="section-negative-feedback" class="form-section">
                <h1 id="negative-title"></h1>
                <p id="negative-subtitle" class="subtitle"></p>
                <form id="internal-feedback-form" class="mt-6">
                    <textarea id="feedback-textarea" rows="5" required></textarea>
                    <button id="submit-feedback-btn" type="submit" class="button mt-4"></button>
                </form>
            </div>
            
            <!-- Step 5: Thank You -->
            <div id="section-thank-you" class="form-section text-center">
                 <div id="thank-you-message">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <h1 id="thank-you-title"></h1>
                    <p id="thank-you-subtitle" class="subtitle"></p>
                 </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const API_BASE_URL = 'https://repup-test.onrender.com';

        // --- DOM Elements ---
        const reviewContainer = document.getElementById('review-container');
        const loader = document.getElementById('loader');
        const appContent = document.getElementById('app-content');
        const sections = document.querySelectorAll('.form-section');

        let restaurantData = {};
        const translations = {
            fr: {
                lang_name: "Français",
                choose_language_title: "Choisissez votre langue",
                server_title: "Qui a enchanté votre service ?",
                server_subtitle: "Sélectionnez la personne qui s'est occupée de vous.",
                rating_title: (server) => `Comment évalueriez-vous le service de <strong>${server}</strong> ?`,
                rating_subtitle: "Votre note nous est précieuse.",
                rating_feedback: ["Terrible", "Moyen", "Bien", "Très bien", "Excellent !"],
                positive_title: "Merci infiniment !",
                positive_subtitle: "Votre avis est essentiel. Aidez d'autres gourmands en le partageant sur une plateforme publique.",
                publish_on: (platform) => `Publier sur ${platform}`,
                no_thanks: "Non merci",
                negative_title: "Nous sommes désolés",
                negative_subtitle: "Votre expérience n'a pas été à la hauteur. Laissez-nous un message privé pour que nous puissions nous améliorer.",
                feedback_placeholder: "Dites-nous tout...",
                submit_feedback: "Envoyer mon retour",
                thank_you_title: "Merci pour votre retour !",
                thank_you_subtitle: "Nous avons bien reçu votre message. À bientôt !",
                final_thank_you_title: "Merci !",
                final_thank_you_subtitle: "Votre soutien est notre plus belle récompense.",
                loading_restaurant: "Chargement des informations du restaurant...",
            },
            en: {
                lang_name: "English",
                choose_language_title: "Choose your language",
                server_title: "Who provided your service?",
                server_subtitle: "Select the person who took care of you.",
                rating_title: (server) => `How would you rate <strong>${server}</strong>'s service?`,
                rating_subtitle: "Your rating is valuable to us.",
                rating_feedback: ["Terrible", "Average", "Good", "Very good", "Excellent!"],
                positive_title: "Thank you so much!",
                positive_subtitle: "Your opinion is essential. Help other food lovers by sharing it on a public platform.",
                publish_on: (platform) => `Publish on ${platform}`,
                no_thanks: "No, thank you",
                negative_title: "We are sorry",
                negative_subtitle: "Your experience was not up to par. Please leave us a private message so we can improve.",
                feedback_placeholder: "Tell us everything...",
                submit_feedback: "Send my feedback",
                thank_you_title: "Thank you for your feedback!",
                thank_you_subtitle: "We have received your message. See you soon!",
                final_thank_you_title: "Thank You!",
                final_thank_you_subtitle: "Your support is our greatest reward.",
                loading_restaurant: "Loading restaurant information...",
            },
            es: {
                lang_name: "Español",
                choose_language_title: "Elige tu idioma",
                server_title: "¿Quién le atendió?",
                server_subtitle: "Seleccione la persona que le atendió.",
                rating_title: (server) => `¿Cómo calificaría el servicio de <strong>${server}</strong>?`,
                rating_subtitle: "Su calificación es muy valiosa para nosotros.",
                rating_feedback: ["Terrible", "Regular", "Bueno", "Muy bueno", "¡Excelente!"],
                positive_title: "¡Muchas gracias!",
                positive_subtitle: "Su opinión es esencial. Ayude a otros gourmets compartiéndola en una plataforma pública.",
                publish_on: (platform) => `Publicar en ${platform}`,
                no_thanks: "No, gracias",
                negative_title: "Lo sentimos",
                negative_subtitle: "Su experiencia no estuvo a la altura. Déjenos un mensaje privado para que podamos mejorar.",
                feedback_placeholder: "Cuéntenos todo...",
                submit_feedback: "Enviar mi comentario",
                thank_you_title: "¡Gracias por su comentario!",
                thank_you_subtitle: "Hemos recibido su mensaje. ¡Hasta pronto!",
                final_thank_you_title: "¡Gracias!",
                final_thank_you_subtitle: "Su apoyo es nuestra mayor recompensa.",
                loading_restaurant: "Cargando información del restaurante...",
            }
        };

        let currentState = {
            section: 'lang',
            lang: 'fr',
            selectedServer: null,
            rating: 0,
        };

        async function fetchRestaurantData() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const slug = urlParams.get('slug');
                if (!slug) throw new Error("Slug du restaurant manquant dans l'URL.");
                
                const response = await fetch(`${API_BASE_URL}/api/public/restaurant/${slug}`);
                if (!response.ok) throw new Error(`Erreur de récupération (code: ${response.status})`);
                
                const data = await response.json();
                restaurantData = { ...data, servers: data.servers || [], languages: data.languages || ['fr', 'en'] };
                currentState.lang = restaurantData.languages.includes('fr') ? 'fr' : restaurantData.languages[0];
                return true;
            } catch (error) {
                loader.innerHTML = `<p class="text-red-500 font-semibold">Erreur de chargement</p><p class="text-gray-600 mt-2">${error.message}</p>`;
                return false;
            }
        }

        function applyBranding() {
            const root = document.documentElement;
            const color = restaurantData.primaryColor || '#BF5B3F';
            root.style.setProperty('--brand-color', color);
            const [r, g, b] = color.match(/\w\w/g).map((c) => parseInt(c, 16));
            root.style.setProperty('--brand-color-light', `rgba(${r}, ${g}, ${b}, 0.1)`);
            root.style.setProperty('--brand-color-dark', `rgb(${Math.max(0, r-20)}, ${Math.max(0, g-20)}, ${Math.max(0, b-20)})`);
            
            document.title = `Donnez votre avis - ${restaurantData.name}`;
            
            const logoUrl = restaurantData.logoUrl ? `${API_BASE_URL}${restaurantData.logoUrl}` : `https://placehold.co/200x60/${color.substring(1)}/FFFFFF?text=${encodeURIComponent(restaurantData.name)}`;
            document.getElementById('logo-container').innerHTML = `<img src="${logoUrl}" alt="Logo de ${restaurantData.name}">`;
        }

        function getTranslation(key, ...args) {
            const langPack = translations[currentState.lang] || translations.fr;
            const translation = langPack[key] || key;
            return typeof translation === 'function' ? translation(...args) : translation;
        }
        
        function renderContent() {
            // Language Switcher
            const langContainer = document.getElementById('lang-container');
            if (restaurantData.languages.length > 1) {
                langContainer.innerHTML = restaurantData.languages.map(langCode => {
                    const langData = translations[langCode] || { lang_name: langCode.toUpperCase() };
                    return `<button class="lang-btn ${currentState.lang === langCode ? 'active' : ''}" data-lang="${langCode}">${langData.lang_name}</button>`;
                }).join('');
            } else {
                langContainer.innerHTML = '';
            }

            // Language Selection Screen
            const langSelector = document.getElementById('lang-selector');
            langSelector.innerHTML = restaurantData.languages.map(langCode => {
                const langData = translations[langCode] || { lang_name: langCode.toUpperCase() };
                return `<button class="button" data-lang-select="${langCode}">${langData.lang_name}</button>`;
            }).join('<div class="my-2"></div>');
            document.querySelector('[data-translate-key="choose_language_title"]').innerText = getTranslation('choose_language_title');


            // Server Step
            document.getElementById('server-title').innerText = getTranslation('server_title');
            document.getElementById('server-subtitle').innerText = getTranslation('server_subtitle');
            document.getElementById('server-grid').innerHTML = restaurantData.servers.map(server => `
                <div class="selection-item" data-server-id="${server.id}" data-server-name="${server.name}">
                    <img src="${server.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(server.name)}&background=eeeeee&color=cccccc`}" alt="Avatar de ${server.name}">
                    <span>${server.name}</span>
                </div>
            `).join('');

            // Rating Step
            document.getElementById('star-rating').innerHTML = Array(5).fill(0).map((_, i) => 
                `<svg data-value="${i + 1}" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>`
            ).join('');

            // Positive Feedback Step
            const positiveButtons = document.getElementById('positive-buttons');
            positiveButtons.innerHTML = '';
            if (restaurantData.links && restaurantData.links.google) {
                positiveButtons.innerHTML += `<a href="${restaurantData.links.google}" target="_blank" class="button">${getTranslation('publish_on', 'Google')}</a>`;
            }
            if (restaurantData.links && restaurantData.links.tripadvisor) {
                positiveButtons.innerHTML += `<a href="${restaurantData.links.tripadvisor}" target="_blank" class="button secondary mt-3">${getTranslation('publish_on', 'TripAdvisor')}</a>`;
            }
            positiveButtons.innerHTML += `<a href="#" id="close-positive-btn" class="block text-center text-sm text-gray-500 mt-6 hover:underline">${getTranslation('no_thanks')}</a>`;

            // Negative Feedback Step
            document.getElementById('feedback-textarea').placeholder = getTranslation('feedback_placeholder');
            document.getElementById('submit-feedback-btn').innerText = getTranslation('submit_feedback');
        }

        function goToSection(sectionName) {
            currentState.section = sectionName;
            sections.forEach(s => s.classList.toggle('active', s.id === `section-${sectionName}`));
            updateSectionContent();
        }

        function updateSectionContent() {
            switch (currentState.section) {
                case 'rating':
                    document.getElementById('rating-title').innerHTML = getTranslation('rating_title', currentState.selectedServer.name);
                    document.getElementById('rating-subtitle').innerText = getTranslation('rating_subtitle');
                    break;
                case 'positive-feedback':
                    document.getElementById('positive-title').innerText = getTranslation('positive_title');
                    document.getElementById('positive-subtitle').innerText = getTranslation('positive_subtitle');
                    break;
                case 'negative-feedback':
                    document.getElementById('negative-title').innerText = getTranslation('negative_title');
                    document.getElementById('negative-subtitle').innerText = getTranslation('negative_subtitle');
                    break;
                case 'thank-you':
                     document.getElementById('thank-you-title').innerText = getTranslation('thank_you_title');
                     document.getElementById('thank-you-subtitle').innerText = getTranslation('thank_you_subtitle');
                    break;
            }
        }
        
        function changeLanguage(langCode) {
            currentState.lang = langCode;
            renderContent();
            updateSectionContent();
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.lang === currentState.lang));
        }

        function setupEventListeners() {
            document.getElementById('lang-container').addEventListener('click', (e) => {
                if (e.target.matches('.lang-btn')) {
                    changeLanguage(e.target.dataset.lang);
                }
            });
            
            document.getElementById('lang-selector').addEventListener('click', (e) => {
                const btn = e.target.closest('[data-lang-select]');
                if (btn) {
                    changeLanguage(btn.dataset.langSelect);
                    goToSection('server');
                }
            });

            document.getElementById('server-grid').addEventListener('click', (e) => {
                const serverItem = e.target.closest('.selection-item');
                if (serverItem) {
                    document.querySelectorAll('.selection-item').forEach(item => item.classList.remove('selected'));
                    serverItem.classList.add('selected');
                    currentState.selectedServer = {
                        id: serverItem.dataset.serverId,
                        name: serverItem.dataset.serverName
                    };
                    setTimeout(() => goToSection('rating'), 300);
                }
            });

            const starRating = document.getElementById('star-rating');
            const stars = starRating.querySelectorAll('svg');
            const ratingFeedback = document.getElementById('rating-feedback');
            
            starRating.addEventListener('click', e => {
                const targetStar = e.target.closest('svg');
                if (targetStar) {
                    currentState.rating = parseInt(targetStar.dataset.value);
                    stars.forEach((star, index) => {
                        star.classList.toggle('selected', index < currentState.rating);
                    });
                    ratingFeedback.textContent = getTranslation('rating_feedback')[currentState.rating - 1];
                    
                    setTimeout(() => {
                        if (currentState.rating >= 4) goToSection('positive-feedback');
                        else goToSection('negative-feedback');
                    }, 800);
                }
            });
            
            document.getElementById('positive-buttons').addEventListener('click', e => {
                if (e.target.id === 'close-positive-btn') {
                    e.preventDefault();
                    document.getElementById('thank-you-title').innerText = getTranslation('final_thank_you_title');
                    document.getElementById('thank-you-subtitle').innerText = getTranslation('final_thank_you_subtitle');
                    goToSection('thank-you');
                }
            });

            document.getElementById('internal-feedback-form').addEventListener('submit', e => {
                e.preventDefault();
                goToSection('thank-you');
            });
        }

        async function init() {
            reviewContainer.classList.add('loaded');
            const success = await fetchRestaurantData();
            if (success) {
                loader.classList.add('hidden');
                appContent.classList.remove('hidden');
                
                applyBranding();
                renderContent();
                setupEventListeners();

                if (restaurantData.languages && restaurantData.languages.length > 1) {
                     goToSection('lang');
                } else if (restaurantData.servers && restaurantData.servers.length > 0) {
                     goToSection('server');
                } else {
                    currentState.selectedServer = { id: 0, name: restaurantData.name };
                    goToSection('rating');
                }
            }
        }

        init();
    });
    </script>
</body>
</html>
