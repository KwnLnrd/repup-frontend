<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donnez votre avis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand-color: #BF5B3F; /* Sera surchargé par JS */
            --brand-color-light: rgba(191, 91, 63, 0.1);
            --brand-color-dark: #A64B35;
            --background-color: #F8F9FA;
            --surface-color: #FFFFFF;
            --text-primary: #212529;
            --text-secondary: #6C757D;
            --border-color: #DEE2E6;
            --font-serif: 'Cormorant Garamond', serif;
            --font-sans: 'Montserrat', sans-serif;
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -1px rgba(0,0,0,.06);
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        body {
            font-family: var(--font-sans);
            background-color: var(--background-color);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .review-container {
            background-color: var(--surface-color);
            border-radius: 12px;
            padding: 28px 32px;
            box-shadow: var(--shadow-md);
            width: 100%;
            max-width: 520px;
            text-align: center;
            border: 1px solid var(--border-color);
            animation: fadeIn .8s ease-out;
            margin: 20px 0;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .review-container.loaded { opacity: 1; }

        .logo-container { margin-bottom: 24px; }
        .logo-container img { max-height: 60px; height: auto; margin: 0 auto; object-fit: contain; }
        
        h1 { font-family: var(--font-serif); font-size: 2rem; margin-bottom: 8px; }
        p.subtitle { font-size: 1rem; line-height: 1.6; color: var(--text-secondary); margin-bottom: 28px; }
        
        .form-section { display: none; animation: fadeIn 0.6s ease-out; text-align: left; }
        .form-section.active { display: block; }
        .form-section.is-empty { display: none !important; }
        .form-section h2 { font-family: var(--font-serif); font-size: 1.5rem; margin-bottom: 12px; color: var(--text-primary); text-align: center; }
        .form-section .subtitle { text-align: center;}

        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 1rem;
        }
        .selection-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .selection-item.selected {
            border-color: var(--brand-color);
            background-color: var(--brand-color-light);
            box-shadow: 0 0 0 2px var(--brand-color);
        }
        .selection-item img {
            width: 64px; height: 64px; border-radius: 50%;
            object-fit: cover; margin-bottom: 0.75rem; background-color: #f0f0f0;
        }
        .selection-item span { font-weight: 500; font-size: 0.9rem; }
        
        .tag-group { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; }
        .tag-group input { position: absolute; opacity: 0; width: 0; height: 0; }
        .tag-group label {
            background-color: var(--surface-color); color: var(--text-secondary);
            padding: 10px 18px; border-radius: 8px; cursor: pointer;
            font-size: .9rem; font-weight: 500; transition: all .3s ease;
            border: 1px solid var(--border-color); user-select: none;
        }
        .tag-group input:checked+label {
            background-color: var(--brand-color); color: #fff; border-color: var(--brand-color);
            box-shadow: 0 4px 15px rgba(191,91,63,.25);
        }
        .tag-group input:disabled+label {
            cursor: not-allowed; background-color: var(--background-color);
            color: #BDBDBD; opacity: 0.7; box-shadow: none;
        }
        .limit-notification { color: var(--brand-color); font-size: 0.9rem; margin-top: 15px; text-align: center; font-weight: 500; transition: opacity 0.3s ease-in-out; }

        textarea {
            width: 100%; padding: 12px; border-radius: 8px;
            border: 1px solid var(--border-color); background-color: var(--surface-color);
            font-family: var(--font-sans); font-size: 1rem; color: var(--text-primary);
            box-sizing: border-box; min-height: 120px; resize: vertical;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        textarea:focus {
            outline: none; border-color: var(--brand-color);
            box-shadow: 0 0 0 3px rgba(191, 91, 63, 0.2);
        }
        
        .button-group { display: flex; justify-content: space-between; margin-top: 2rem; }
        .button {
            display: inline-block; background-color: var(--brand-color); color: #fff; border: none;
            padding: 14px 28px; border-radius: 50px; font-size: 1rem; font-weight: 600;
            cursor: pointer; width: 100%; transition: all .3s ease; text-decoration: none;
            box-sizing: border-box;
        }
        .button:hover {
            background-color: var(--brand-color-dark); transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .button.secondary {
            background: var(--surface-color); color: var(--brand-color);
            border: 1px solid var(--brand-color);
        }
        .button.secondary:hover { background-color: var(--brand-color-light); }
        .button.nav-btn { width: auto; min-width: 120px; }

        #loader { text-align: center; padding: 3rem; }
        .loader-dots div {
            width: 12px; height: 12px; background-color: var(--brand-color);
            border-radius: 100%; display: inline-block;
            animation: sk-bouncedelay 1.4s infinite ease-in-out both;
        }
        .loader-dots .bounce1 { animation-delay: -0.32s; }
        .loader-dots .bounce2 { animation-delay: -0.16s; }
        @keyframes sk-bouncedelay {
          0%, 80%, 100% { transform: scale(0); }
          40% { transform: scale(1.0); }
        }

        /* Nouveaux styles pour l'écran de résultat */
        .contribution-box {
            border: 1px solid #FBC2C2;
            background-color: #FFF8F8;
            border-radius: 8px;
            padding: 1rem 1.5rem;
            margin: 1.5rem auto;
            color: #444;
        }
        .contribution-box p, .contribution-box li {
             font-size: 0.95rem;
        }

        .review-text-display {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            text-align: left;
            white-space: pre-wrap;
            background-color: #fdfdfd;
            font-size: 0.95rem;
            line-height: 1.6;
            color: #333;
        }

        #result-buttons .button {
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            border-radius: 8px;
        }
        #result-buttons .button.secondary {
            background: #fff;
            color: #333;
            border: 1px solid #ccc;
        }
        #result-buttons .button.secondary:hover {
            background: #f5f5f5;
        }
        #result-buttons .button#google-btn {
            background-color: var(--brand-color);
        }
        #result-buttons .button#google-btn:hover {
            background-color: var(--brand-color-dark);
        }

        @media (max-width: 600px) {
            body { padding: 10px; }
            .review-container { padding: 20px 15px; margin: 10px 0; }
            h1, .form-section h2 { font-size: 1.8rem; }
        }
    </style>
</head>
<body class="antialiased">

    <div id="review-container" class="review-container">
        <div id="loader">
            <p data-translate-key="loading_restaurant">Chargement des informations...</p>
        </div>
        
        <div id="app-content" class="hidden">
            <div class="logo-container" id="logo-container"></div>

            <div id="section-lang" class="form-section">
                 <h2 data-translate-key="lang_title">Choisissez votre langue</h2>
                 <div class="tag-group mt-6">
                    <!-- Language buttons injected here -->
                 </div>
            </div>

            <div id="section-server" class="form-section">
                <h2 data-translate-key="server_title">Qui a enchanté votre service ?</h2>
                <div id="server-grid" class="selection-grid mt-6"></div>
                <div id="service-qualities-container" class="hidden mt-4">
                    <h3 class="text-lg font-semibold text-center mb-4" data-translate-key="service_subtitle">Qu'avez-vous particulièrement apprécié ?</h3>
                    <p class="limit-notification hidden"></p>
                    <div id="service-qualities-tags" class="tag-group"></div>
                </div>
            </div>

            <div id="section-occasion" class="form-section">
                <h2 data-translate-key="occasion_title">Une occasion spéciale ?</h2>
                <div id="occasion-tags" class="tag-group mt-6"></div>
            </div>

            <div id="section-flavors" class="form-section">
                <h2 data-translate-key="flavors_title">Les saveurs qui vous ont marqué</h2>
                <p class="subtitle" data-translate-key="flavors_subtitle">Choisissez jusqu'à 6 de vos coups de cœur.</p>
                <p class="limit-notification hidden"></p>
                <div id="flavors-tags" class="tag-group mt-4"></div>
            </div>

            <div id="section-atmosphere" class="form-section">
                <h2 data-translate-key="atmosphere_title">L'atmosphère du lieu</h2>
                <p class="subtitle" data-translate-key="atmosphere_subtitle">Sélectionnez jusqu'à 3 options.</p>
                <p class="limit-notification hidden"></p>
                <div id="atmosphere-tags" class="tag-group mt-4"></div>
            </div>

            <div id="section-feedback" class="form-section">
                <h2 data-translate-key="feedback_title">Une suggestion privée ?</h2>
                <p class="subtitle" data-translate-key="feedback_subtitle">Ce message sera envoyé uniquement à l'équipe (optionnel).</p>
                <textarea id="feedback-textarea" rows="5" class="mt-2"></textarea>
            </div>
            
            <div id="section-result" class="form-section text-center">
                <div id="generation-loader">
                    <h2 data-translate-key="generating_title">Création de votre avis...</h2>
                    <p class="subtitle" data-translate-key="generating_subtitle">Notre IA personnalise votre expérience.</p>
                    <div class="loader-dots mt-6">
                        <div class="bounce1"></div><div class="bounce2"></div><div class="bounce3"></div>
                    </div>
                </div>
                <div id="result-display" class="hidden">
                    <h1 data-translate-key="result_title">Une soirée mémorable ?</h1>
                    <p class="subtitle" data-translate-key="result_subtitle">Votre avis est la touche finale de votre expérience.</p>
                    
                    <div class="contribution-box">
                        <p class="font-bold text-center text-lg" data-translate-key="result_thank_you">Merci pour votre contribution !</p>
                        <div class="text-left mt-4">
                            <p class="font-semibold" data-translate-key="result_follow_steps">Suivez ces 2 étapes :</p>
                            <ol class="list-decimal list-inside ml-2 mt-1 space-y-1">
                                <li data-translate-key="result_step1">Cliquez sur 'Copier le texte'.</li>
                                <li data-translate-key="result_step2">Cliquez sur 'Publier sur Google' et collez votre avis.</li>
                            </ol>
                        </div>
                    </div>

                    <div id="review-text-display" class="review-text-display">
                        <!-- Le texte de l'avis généré sera injecté ici -->
                    </div>

                    <div id="result-buttons" class="mt-6 space-y-3">
                        <button id="copy-btn" class="button secondary" data-translate-key="copy_button">Copier le texte</button>
                        <a id="google-btn" href="#" target="_blank" class="button" data-translate-key="publish_on_google">Publier mon avis sur Google</a>
                        <a id="tripadvisor-btn" href="#" target="_blank" class="button hidden" data-translate-key="publish_on_tripadvisor">Publier sur TripAdvisor</a>
                    </div>
                </div>
            </div>

            <div id="navigation-buttons" class="button-group">
                <button id="back-btn" class="button secondary nav-btn">Précédent</button>
                <button id="next-btn" class="button nav-btn">Suivant</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const API_BASE_URL = 'https://repup-test.onrender.com';
        
        const reviewContainer = document.getElementById('review-container');
        const loader = document.getElementById('loader');
        const appContent = document.getElementById('app-content');
        const sections = document.querySelectorAll('.form-section');
        const nextBtn = document.getElementById('next-btn');
        const backBtn = document.getElementById('back-btn');
        const navButtons = document.getElementById('navigation-buttons');

        let restaurantData = {};
        let reviewData = {
            lang: 'fr', server: null, serviceQualities: [], occasion: null,
            flavors: [], atmosphere: [], privateFeedback: ''
        };
        
        const sectionOrder = ['lang', 'server', 'occasion', 'flavors', 'atmosphere', 'feedback', 'result'];
        let currentSectionIndex = 0;

        const translations = {
            fr: {
                lang_name_native: "🇫🇷 Français",
                lang_title: "Choisissez votre langue",
                server_title: "Qui a enchanté votre service ?",
                service_subtitle: "Qu'avez-vous particulièrement apprécié ? (3 max)",
                occasion_title: "Une occasion spéciale ?",
                flavors_title: "Les saveurs qui vous ont marqué",
                flavors_subtitle: "Choisissez jusqu'à 6 de vos coups de cœur.",
                atmosphere_title: "L'atmosphère du lieu",
                atmosphere_subtitle: "Sélectionnez jusqu'à 3 options.",
                feedback_title: "Une suggestion privée ?",
                feedback_subtitle: "Ce message sera envoyé uniquement à l'équipe (optionnel).",
                generating_title: "Création de votre avis...",
                generating_subtitle: "Notre IA personnalise votre expérience.",
                result_title: "Une soirée mémorable ?",
                result_subtitle: "Votre avis est la touche finale de votre expérience.",
                result_thank_you: "Merci pour votre contribution !",
                result_follow_steps: "Suivez ces 2 étapes :",
                result_step1: "1. Cliquez sur 'Copier le texte'.",
                result_step2: "2. Cliquez sur 'Publier sur Google' et collez votre avis.",
                copy_button: "Copier le texte",
                publish_on_google: "Publier mon avis sur Google",
                publish_on_tripadvisor: "Publier sur TripAdvisor",
                loading_restaurant: "Chargement...",
                nav_next: "Suivant",
                nav_back: "Précédent",
                nav_generate: "Générer mon avis",
                limit_reached: (limit) => `Limite de ${limit} choix atteinte.`,
                api_key_error: "Erreur : La clé API n'est pas configurée. Veuillez contacter le propriétaire du site."
            },
            en: {
                lang_name_native: "�🇧 English",
                lang_title: "Choose your language",
                server_title: "Who provided your service?",
                service_subtitle: "What did you particularly appreciate? (3 max)",
                occasion_title: "A special occasion?",
                flavors_title: "The flavors that stood out",
                flavors_subtitle: "Choose up to 6 of your favorites.",
                atmosphere_title: "The atmosphere",
                atmosphere_subtitle: "Select up to 3 options.",
                feedback_title: "A private suggestion?",
                feedback_subtitle: "This message will be sent only to the team (optional).",
                generating_title: "Creating your review...",
                generating_subtitle: "Our AI is personalizing your experience.",
                result_title: "A memorable evening?",
                result_subtitle: "Your review is the final touch to your experience.",
                result_thank_you: "Thank you for your contribution!",
                result_follow_steps: "Follow these 2 steps:",
                result_step1: "1. Click on 'Copy text'.",
                result_step2: "2. Click on 'Publish on Google' and paste your review.",
                copy_button: "Copy text",
                publish_on_google: "Publish on Google",
                publish_on_tripadvisor: "Publish on TripAdvisor",
                loading_restaurant: "Loading...",
                nav_next: "Next",
                nav_back: "Back",
                nav_generate: "Generate my review",
                limit_reached: (limit) => `Limit of ${limit} choices reached.`,
                api_key_error: "Error: API Key is not configured. Please contact the site owner."
            },
            es: { lang_name_native: "🇪🇸 Español" },
            pt: { lang_name_native: "🇵🇹 Português" },
            it: { lang_name_native: "🇮🇹 Italiano" },
            zh: { lang_name_native: "🇨🇳 简体中文" }
        };

        function getTranslation(key, ...args) {
            const langPack = translations[reviewData.lang] || translations.fr;
            const translation = langPack[key] || key;
            return typeof translation === 'function' ? translation(...args) : translation;
        }

        function translatePage() {
            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.dataset.translateKey;
                el.innerHTML = getTranslation(key);
            });
            nextBtn.innerText = getTranslation('nav_next');
            backBtn.innerText = getTranslation('nav_back');
        }

        async function fetchRestaurantData() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const slug = urlParams.get('slug');
                if (!slug) throw new Error("Slug manquant.");
                
                const response = await fetch(`${API_BASE_URL}/api/public/restaurant/${slug}`);
                if (!response.ok) throw new Error(`Erreur serveur (code: ${response.status})`);
                
                const data = await response.json();
                restaurantData = { ...data, servers: data.servers || [], languages: data.languages || ['fr', 'en'], tags: data.tags || {} };
                
                const menuResponse = await fetch(`${API_BASE_URL}/api/public/menu/${slug}`);
                if (menuResponse.ok) {
                    restaurantData.menu = await menuResponse.json();
                } else {
                    console.warn(`Could not fetch menu (status: ${menuResponse.status}). The flavor section will be empty.`);
                    restaurantData.menu = {};
                }

                reviewData.lang = restaurantData.languages.includes('fr') ? 'fr' : restaurantData.languages[0];
                return true;
            } catch (error) {
                loader.innerHTML = `<p class="text-red-500 font-semibold">Erreur de chargement</p><p class="text-gray-600 mt-2">${error.message}</p>`;
                return false;
            }
        }

        function applyBranding() {
            const root = document.documentElement;
            const color = restaurantData.primaryColor || '#BF5B3F';
            root.style.setProperty('--brand-color', color);
            const [r, g, b] = color.match(/\w\w/g).map((c) => parseInt(c, 16));
            root.style.setProperty('--brand-color-light', `rgba(${r}, ${g}, ${b}, 0.1)`);
            root.style.setProperty('--brand-color-dark', `rgb(${Math.max(0, r-20)}, ${Math.max(0, g-20)}, ${Math.max(0, b-20)})`);
            
            document.title = `Avis - ${restaurantData.name}`;
            const logoUrl = restaurantData.logoUrl ? `${API_BASE_URL}${restaurantData.logoUrl}` : `https://placehold.co/200x60/${color.substring(1)}/FFFFFF?text=${encodeURIComponent(restaurantData.name)}`;
            document.getElementById('logo-container').innerHTML = `<img src="${logoUrl}" alt="Logo de ${restaurantData.name}">`;
        }

        function renderAllSections() {
            const langContainer = document.querySelector('#section-lang .tag-group');
            langContainer.innerHTML = (restaurantData.languages || ['fr', 'en']).map(lang => {
                const langName = translations[lang]?.lang_name_native || lang.toUpperCase();
                return `<button class="button" data-lang-select="${lang}">${langName}</button>`;
            }).join('');
            
            document.getElementById('server-grid').innerHTML = restaurantData.servers.map(server => {
                const avatarSrc = server.avatar_url 
                    ? `${API_BASE_URL}${server.avatar_url}` 
                    : `https://ui-avatars.com/api/?name=${encodeURIComponent(server.name)}&background=eeeeee&color=555555`;
                return `
                    <div class="selection-item" data-server-name="${server.name}">
                        <img src="${avatarSrc}" alt="${server.name}">
                        <span>${server.name}</span>
                    </div>`;
            }).join('');

            const serviceTags = restaurantData.tags?.service || [];
            document.getElementById('service-qualities-tags').innerHTML = serviceTags.map(tag => `
                <input type="checkbox" id="service_${tag.id}" name="service_quality" value="${tag.text}"><label for="service_${tag.id}">${tag.text}</label>
            `).join('');

            const occasionTags = restaurantData.tags?.occasion || [];
            document.getElementById('occasion-tags').innerHTML = occasionTags.map(tag => `
                <input type="radio" id="occasion_${tag.id}" name="occasion" value="${tag.text}"><label for="occasion_${tag.id}">${tag.text}</label>
            `).join('');
            
            const atmosphereTags = restaurantData.tags?.atmosphere || [];
            document.getElementById('atmosphere-tags').innerHTML = atmosphereTags.map(tag => `
                <input type="checkbox" id="atmosphere_${tag.id}" name="atmosphere" value="${tag.text}"><label for="atmosphere_${tag.id}">${tag.text}</label>
            `).join('');

            const flavorsContainer = document.getElementById('flavors-tags');
            const flavorsSection = document.getElementById('section-flavors');
            flavorsContainer.innerHTML = '';
            if(restaurantData.menu && Object.keys(restaurantData.menu).length > 0) {
                flavorsSection.classList.remove('is-empty');
                Object.entries(restaurantData.menu).forEach(([category, dishes]) => {
                    dishes.forEach(dish => {
                        flavorsContainer.innerHTML += `<input type="checkbox" id="dish_${dish.id}" name="flavor" value="${dish.name}"><label for="dish_${dish.id}">${dish.name}</label>`;
                    });
                });
            } else {
                flavorsSection.classList.add('is-empty');
            }

            translatePage();
        }

        function updateNavButtons() {
            backBtn.style.visibility = currentSectionIndex > 0 ? 'visible' : 'hidden';
            if (currentSectionIndex === sectionOrder.indexOf('feedback')) {
                nextBtn.innerText = getTranslation('nav_generate');
            } else {
                nextBtn.innerText = getTranslation('nav_next');
            }
        }

        function goToSection(index) {
            const sectionId = `section-${sectionOrder[index]}`;
            const sectionElement = document.getElementById(sectionId);
            if (sectionElement && sectionElement.classList.contains('is-empty')) {
                const direction = index > currentSectionIndex ? 1 : -1;
                goToSection(index + direction);
                return;
            }
            
            currentSectionIndex = index;
            sections.forEach((s) => s.classList.remove('active'));
            if(sectionElement) sectionElement.classList.add('active');
            updateNavButtons();
        }
        
        async function generateReview() {
            goToSection(sectionOrder.indexOf('result'));
            navButtons.style.display = 'none';
            document.getElementById('generation-loader').classList.remove('hidden');
            document.getElementById('result-display').classList.add('hidden');

            const promptParts = [];
            promptParts.push(`Rédige un avis de restaurant en langue "${reviewData.lang}" pour "${restaurantData.name}". Le ton doit être positif et engageant. Voici les détails de l'expérience :`);
            if (reviewData.server) promptParts.push(`- Le service a été assuré par ${reviewData.server}.`);
            if (reviewData.serviceQualities.length > 0) promptParts.push(`- Qualités du service remarquées : ${reviewData.serviceQualities.join(', ')}.`);
            if (reviewData.occasion) promptParts.push(`- L'occasion de la visite était : ${reviewData.occasion}.`);
            if (reviewData.flavors.length > 0) promptParts.push(`- Plats et saveurs particulièrement appréciés : ${reviewData.flavors.join(', ')}.`);
            if (reviewData.atmosphere.length > 0) promptParts.push(`- Points forts de l'atmosphère : ${reviewData.atmosphere.join(', ')}.`);
            if (reviewData.privateFeedback) promptParts.push(`Ne mentionne pas la suggestion privée suivante dans l'avis public : "${reviewData.privateFeedback}"`);
            promptParts.push("Termine par une recommandation chaleureuse.");
            
            const prompt = promptParts.join('\n');

            try {
                const apiUrl = `${API_BASE_URL}/api/generate-review`;
                const payload = { prompt: prompt };
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || `Erreur serveur: ${response.status}`);
                }
                
                if (result.review) {
                    const reviewDisplay = document.getElementById('review-text-display');
                    reviewDisplay.innerText = result.review.trim();
                } else {
                    throw new Error("La réponse du serveur est valide mais le contenu est manquant.");
                }

            } catch (error) {
                console.error("Error in generateReview function:", error);
                document.getElementById('review-text-display').innerText = error.message;
            } finally {
                translatePage(); // Re-translate the result page specifically
                document.getElementById('generation-loader').classList.add('hidden');
                document.getElementById('result-display').classList.remove('hidden');
            }
        }

        function setupEventListeners() {
            nextBtn.addEventListener('click', () => {
                if (currentSectionIndex < sectionOrder.length - 1) {
                    if (sectionOrder[currentSectionIndex] === 'feedback') {
                        reviewData.privateFeedback = document.getElementById('feedback-textarea').value;
                        generateReview();
                    } else {
                        goToSection(currentSectionIndex + 1);
                    }
                }
            });
            backBtn.addEventListener('click', () => {
                if (currentSectionIndex > 0) goToSection(currentSectionIndex - 1);
            });

            document.querySelector('#section-lang').addEventListener('click', e => {
                if(e.target.dataset.langSelect) {
                    reviewData.lang = e.target.dataset.langSelect;
                    renderAllSections();
                    goToSection(currentSectionIndex + 1);
                }
            });

            document.getElementById('server-grid').addEventListener('click', e => {
                const serverItem = e.target.closest('.selection-item');
                if (serverItem) {
                    document.querySelectorAll('#server-grid .selection-item').forEach(i => i.classList.remove('selected'));
                    serverItem.classList.add('selected');
                    reviewData.server = serverItem.dataset.serverName;
                    document.getElementById('service-qualities-container').classList.remove('hidden');
                }
            });

            function setupCheckboxLimit(containerId, category, limit) {
                const container = document.getElementById(containerId);
                const notificationEl = container.parentElement.querySelector('.limit-notification');
                container.addEventListener('change', e => {
                    if (e.target.type === 'checkbox') {
                        const checked = container.querySelectorAll('input:checked');
                        reviewData[category] = Array.from(checked).map(cb => cb.value);
                        
                        if (checked.length >= limit) {
                            container.querySelectorAll('input:not(:checked)').forEach(cb => cb.disabled = true);
                            if(notificationEl) {
                                notificationEl.innerText = getTranslation('limit_reached', limit);
                                notificationEl.classList.remove('hidden');
                            }
                        } else {
                            container.querySelectorAll('input').forEach(cb => cb.disabled = false);
                            if(notificationEl) notificationEl.classList.add('hidden');
                        }
                    }
      