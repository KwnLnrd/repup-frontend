<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donnez votre avis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@700&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Palette de couleurs et polices de index.html */
        :root {
            --color-bg: #F8F9FA;
            --color-text: #2D3748;
            --color-primary: #D69E2E; /* Couleur par défaut, sera surchargée par JS */
            --color-primary-dark: #B7791F;
            --color-surface: #FFFFFF;
            --color-border: #DEE2E6;
            --font-serif: 'Cormorant Garamond', serif;
            --font-sans: 'Montserrat', sans-serif;
            --shadow-xl: 0 20px 25px -5px rgba(0,0,0,.1), 0 10px 10px -5px rgba(0,0,0,.04);
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        body {
            font-family: var(--font-sans);
            background-color: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .review-container {
            background-color: var(--color-surface);
            border-radius: 1rem;
            padding: 28px 32px;
            box-shadow: var(--shadow-xl);
            width: 100%;
            max-width: 520px;
            text-align: center;
            border: 1px solid var(--color-border);
            animation: fadeIn .8s ease-out;
            margin: 20px 0;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .review-container.loaded { opacity: 1; }

        .logo-container { margin-bottom: 24px; }
        .logo-container img { max-height: 60px; height: auto; margin: 0 auto; object-fit: contain; }
        
        h1 { font-family: var(--font-serif); font-size: 2rem; margin-bottom: 8px; }
        p.subtitle { font-size: 1rem; line-height: 1.6; color: var(--color-text); opacity: 0.8; margin-bottom: 28px; }
        
        .form-section { display: none; animation: fadeIn 0.6s ease-out; text-align: left; }
        .form-section.active { display: block; }
        .form-section.is-empty { display: none !important; }
        .form-section h2 { font-family: var(--font-serif); font-size: 1.8rem; margin-bottom: 12px; color: var(--color-text); text-align: center; }
        .form-section .subtitle { text-align: center;}

        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 1rem;
        }
        .selection-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            border: 1px solid var(--color-border);
            border-radius: 0.75rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .selection-item.selected {
            border-color: var(--color-primary);
            background-color: rgba(214, 158, 46, 0.1); /* Utilise la couleur de base pour le RGBA */
            box-shadow: 0 0 0 2px var(--color-primary);
        }
        .selection-item img {
            width: 64px; height: 64px; border-radius: 50%;
            object-fit: cover; margin-bottom: 0.75rem; background-color: #f0f0f0;
        }
        .selection-item span { font-weight: 500; font-size: 0.9rem; }
        
        .tag-group { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; }
        .tag-group input { position: absolute; opacity: 0; width: 0; height: 0; }
        .tag-group label {
            background-color: var(--color-surface); color: #6C757D;
            padding: 10px 18px; border-radius: 50px; cursor: pointer;
            font-size: .9rem; font-weight: 600; transition: all .3s ease;
            border: 1px solid var(--color-border); user-select: none;
        }
        .tag-group input:checked+label {
            background-color: var(--color-primary); color: #fff; border-color: var(--color-primary);
            box-shadow: 0 4px 15px rgba(0,0,0,.1);
        }
        .tag-group input:disabled+label {
            cursor: not-allowed; background-color: var(--color-bg);
            color: #BDBDBD; opacity: 0.7; box-shadow: none;
        }
        .limit-notification { color: var(--color-primary); font-size: 0.9rem; margin-top: 15px; text-align: center; font-weight: 500; transition: opacity 0.3s ease-in-out; }

        textarea {
            width: 100%; padding: 12px; border-radius: 8px;
            border: 1px solid var(--color-border); background-color: var(--color-surface);
            font-family: var(--font-sans); font-size: 1rem; color: var(--color-text);
            box-sizing: border-box; min-height: 120px; resize: vertical;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        textarea:focus {
            outline: none; border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(214, 158, 46, 0.2);
        }
        
        .button-group { display: flex; justify-content: space-between; margin-top: 2rem; }
        .button {
            display: inline-block; background-color: var(--color-primary); color: #fff; border: none;
            padding: 14px 28px; border-radius: 50px; font-size: 1rem; font-weight: 700;
            cursor: pointer; width: 100%; transition: all .3s ease; text-decoration: none;
            box-sizing: border-box;
        }
        .button:hover {
            background-color: var(--color-primary-dark); transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .button.secondary {
            background: var(--color-surface); color: var(--color-text);
            border: 1px solid var(--color-border); font-weight: 600;
        }
        .button.secondary:hover { background-color: #f1f1f1; }
        .button.nav-btn { width: auto; min-width: 120px; }

        #loader { text-align: center; padding: 3rem; }
        .loader-dots div {
            width: 12px; height: 12px; background-color: var(--color-primary);
            border-radius: 100%; display: inline-block;
            animation: sk-bouncedelay 1.4s infinite ease-in-out both;
        }
        .loader-dots .bounce1 { animation-delay: -0.32s; }
        .loader-dots .bounce2 { animation-delay: -0.16s; }
        @keyframes sk-bouncedelay {
          0%, 80%, 100% { transform: scale(0); }
          40% { transform: scale(1.0); }
        }

        .contribution-box {
            border: 1px solid rgba(214, 158, 46, 0.3);
            background-color: rgba(214, 158, 46, 0.05);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            margin: 1.5rem auto;
            color: var(--color-text);
        }
        .contribution-box p, .contribution-box li {
             font-size: 0.95rem;
        }

        .review-text-display {
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            text-align: left;
            white-space: pre-wrap;
            background-color: #fdfdfd;
            font-size: 0.95rem;
            line-height: 1.6;
            color: #333;
        }

        #result-buttons .button {
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        #result-buttons .button.secondary {
            background: var(--color-surface);
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }
        #result-buttons .button.secondary:hover {
            background-color: #f1f1f1;
        }
        #result-buttons .button#google-btn, #result-buttons .button#tripadvisor-btn {
            background-color: var(--color-primary);
        }
        #result-buttons .button#google-btn:hover, #result-buttons .button#tripadvisor-btn:hover {
            background-color: var(--color-primary-dark);
        }
        
        .font-serif {
             font-family: var(--font-serif);
        }
        .lang-button {
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 600;
            border: 1px solid var(--color-border);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .lang-button:hover {
            border-color: var(--color-primary);
            color: var(--color-primary);
        }


        @media (max-width: 600px) {
            body { padding: 10px; }
            .review-container { padding: 20px 15px; margin: 10px 0; }
            h1, .form-section h2 { font-size: 1.8rem; }
        }
    </style>
</head>
<body class="antialiased">

    <div id="review-container" class="review-container">
        <!-- Le contenu initial est juste le loader -->
        <div id="loader">
            <p data-translate-key="loading_restaurant">Chargement des informations...</p>
             <div class="loader-dots mt-6">
                <div class="bounce1"></div><div class="bounce2"></div><div class="bounce3"></div>
            </div>
        </div>
        
        <!-- L'application sera injectée ici par le script si tout se passe bien -->
        <div id="app-content" class="hidden">
            <div class="logo-container" id="logo-container"></div>

            <div id="section-lang" class="form-section">
                 <h2 data-translate-key="lang_title">Choisissez votre langue</h2>
                 <div class="flex flex-wrap justify-center gap-4 mt-6">
                    <!-- Les boutons de langue seront injectés ici -->
                 </div>
            </div>

            <div id="section-server" class="form-section">
                <h2 data-translate-key="server_title">Qui a enchanté votre service ?</h2>
                <div id="server-grid" class="selection-grid mt-6"></div>
                <div id="service-qualities-container" class="hidden mt-8">
                    <h3 class="text-lg font-serif font-semibold text-center mb-4" data-translate-key="service_subtitle">Qu'avez-vous particulièrement apprécié ?</h3>
                    <p class="limit-notification hidden"></p>
                    <div id="service-tags" class="tag-group"></div>
                </div>
            </div>

            <div id="section-occasion" class="form-section">
                <h2 data-translate-key="occasion_title">Une occasion spéciale ?</h2>
                <div id="occasion-tags" class="tag-group mt-6"></div>
            </div>

            <div id="section-flavors" class="form-section">
                <h2 data-translate-key="flavors_title">Les saveurs qui vous ont marqué</h2>
                <p class="subtitle" data-translate-key="flavors_subtitle">Choisissez jusqu'à 6 de vos coups de cœur.</p>
                <p class="limit-notification hidden"></p>
                <div id="flavors-tags" class="tag-group mt-4"></div>
            </div>

            <div id="section-atmosphere" class="form-section">
                <h2 data-translate-key="atmosphere_title">L'atmosphère du lieu</h2>
                <p class="subtitle" data-translate-key="atmosphere_subtitle">Sélectionnez jusqu'à 3 options.</p>
                <p class="limit-notification hidden"></p>
                <div id="atmosphere-tags" class="tag-group mt-4"></div>
            </div>

            <div id="section-feedback" class="form-section">
                <h2 data-translate-key="feedback_title">Une suggestion privée ?</h2>
                <p class="subtitle" data-translate-key="feedback_subtitle">Ce message sera envoyé uniquement à l'équipe (optionnel).</p>
                <textarea id="feedback-textarea" rows="5" class="mt-2"></textarea>
            </div>
            
            <div id="section-result" class="form-section text-center">
                <div id="generation-loader">
                    <h2 data-translate-key="generating_title">Création de votre avis...</h2>
                    <p class="subtitle" data-translate-key="generating_subtitle">Notre IA personnalise votre expérience.</p>
                    <div class="loader-dots mt-6">
                        <div class="bounce1"></div><div class="bounce2"></div><div class="bounce3"></div>
                    </div>
                </div>
                <div id="result-display" class="hidden">
                    <h2 data-translate-key="result_title" class="font-serif text-3xl font-semibold mb-2">Une soirée mémorable ?</h2>
                    <p class="subtitle" data-translate-key="result_subtitle">Votre avis est la touche finale de votre expérience.</p>
                    
                    <div class="contribution-box">
                        <p class="font-bold text-center text-lg" data-translate-key="result_thank_you">Merci pour votre contribution !</p>
                        <div class="text-left mt-4">
                            <p class="font-semibold" data-translate-key="result_follow_steps">Suivez ces 2 étapes :</p>
                            <ol class="list-decimal list-inside ml-2 mt-1 space-y-1">
                                <li data-translate-key="result_step1">Cliquez sur 'Copier le texte'.</li>
                                <li data-translate-key="result_step2">Cliquez sur 'Publier sur Google' et collez votre avis.</li>
                            </ol>
                        </div>
                    </div>

                    <div id="review-text-display" class="review-text-display">
                        <!-- Le texte de l'avis généré sera injecté ici -->
                    </div>

                    <div id="result-buttons" class="mt-6 space-y-3">
                        <button id="copy-btn" class="button secondary" data-translate-key="copy_button">Copier le texte</button>
                        <a id="google-btn" href="#" target="_blank" class="button" data-translate-key="publish_on_google">Publier sur Google</a>
                        <a id="tripadvisor-btn" href="#" target="_blank" class="button hidden" data-translate-key="publish_on_tripadvisor">Publier sur TripAdvisor</a>
                    </div>
                </div>
            </div>

            <div id="navigation-buttons" class="button-group">
                <button id="back-btn" class="button secondary nav-btn">Précédent</button>
                <button id="next-btn" class="button nav-btn">Suivant</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        // IMPORTANT: Ne pas changer l'URL de l'API
        const API_BASE_URL = 'https://repup-test.onrender.com';
        
        const reviewContainer = document.getElementById('review-container');
        const loader = document.getElementById('loader');
        const appContent = document.getElementById('app-content');
        const sections = document.querySelectorAll('.form-section');
        const nextBtn = document.getElementById('next-btn');
        const backBtn = document.getElementById('back-btn');
        const navButtons = document.getElementById('navigation-buttons');

        let restaurantData = {};
        let reviewData = {
            lang: 'fr', server: null, serviceQualities: [], occasion: null,
            flavors: [], atmosphere: [], privateFeedback: ''
        };
        
        const sectionOrder = ['lang', 'server', 'occasion', 'flavors', 'atmosphere', 'feedback', 'result'];
        let currentSectionIndex = 0;

        const translations = {
            fr: {
                lang_name_native: "🇫🇷 Français",
                lang_title: "Choisissez votre langue",
                server_title: "Qui a enchanté votre service ?",
                service_subtitle: "Qu'avez-vous particulièrement apprécié ? (3 max)",
                occasion_title: "Une occasion spéciale ?",
                flavors_title: "Les saveurs qui vous ont marqué",
                flavors_subtitle: "Choisissez jusqu'à 6 de vos coups de cœur.",
                atmosphere_title: "L'atmosphère du lieu",
                atmosphere_subtitle: "Sélectionnez jusqu'à 3 options.",
                feedback_title: "Une suggestion privée ?",
                feedback_subtitle: "Ce message sera envoyé uniquement à l'équipe (optionnel).",
                generating_title: "Création de votre avis...",
                generating_subtitle: "Notre IA personnalise votre expérience.",
                result_title: "Une soirée mémorable ?",
                result_subtitle: "Votre avis est la touche finale de votre expérience.",
                result_thank_you: "Merci pour votre contribution !",
                result_follow_steps: "Suivez ces 2 étapes :",
                result_step1: "1. Cliquez sur 'Copier le texte'.",
                result_step2: "2. Cliquez sur 'Publier sur Google' et collez votre avis.",
                copy_button: "Copier le texte",
                publish_on_google: "Publier sur Google",
                publish_on_tripadvisor: "Publier sur TripAdvisor",
                loading_restaurant: "Chargement...",
                nav_next: "Suivant",
                nav_back: "Précédent",
                nav_generate: "Générer mon avis",
                limit_reached: (limit) => `Limite de ${limit} choix atteinte.`,
                api_key_error: "Erreur : La clé API n'est pas configurée. Veuillez contacter le propriétaire du site."
            },
            en: {
                lang_name_native: "🇬🇧 English",
                lang_title: "Choose your language",
                server_title: "Who provided your service?",
                service_subtitle: "What did you particularly appreciate? (3 max)",
                occasion_title: "A special occasion?",
                flavors_title: "The flavors that stood out",
                flavors_subtitle: "Choose up to 6 of your favorites.",
                atmosphere_title: "The atmosphere",
                atmosphere_subtitle: "Select up to 3 options.",
                feedback_title: "A private suggestion?",
                feedback_subtitle: "This message will be sent only to the team (optional).",
                generating_title: "Creating your review...",
                generating_subtitle: "Our AI is personalizing your experience.",
                result_title: "A memorable evening?",
                result_subtitle: "Your review is the final touch to your experience.",
                result_thank_you: "Thank you for your contribution!",
                result_follow_steps: "Follow these 2 steps:",
                result_step1: "1. Click on 'Copy text'.",
                result_step2: "2. Click on 'Publish on Google' and paste your review.",
                copy_button: "Copy text",
                publish_on_google: "Publish on Google",
                publish_on_tripadvisor: "Publish on TripAdvisor",
                loading_restaurant: "Loading...",
                nav_next: "Next",
                nav_back: "Back",
                nav_generate: "Generate my review",
                limit_reached: (limit) => `Limit of ${limit} choices reached.`,
                api_key_error: "Error: API Key is not configured. Please contact the site owner."
            },
            es: {
                lang_name_native: "🇪🇸 Español",
                lang_title: "Elige tu idioma",
                server_title: "¿Quién te atendió?",
                service_subtitle: "¿Qué te gustó especialmente? (máx. 3)",
                occasion_title: "¿Una ocasión especial?",
                flavors_title: "Los sabores que te marcaron",
                flavors_subtitle: "Elige hasta 6 de tus favoritos.",
                atmosphere_title: "El ambiente del lugar",
                atmosphere_subtitle: "Selecciona hasta 3 opciones.",
                feedback_title: "¿Alguna sugerencia privada?",
                feedback_subtitle: "Este mensaje se enviará solo al equipo (opcional).",
                generating_title: "Creando tu reseña...",
                generating_subtitle: "Nuestra IA está personalizando tu experiencia.",
                result_title: "¿Una velada memorable?",
                result_subtitle: "Tu reseña es el toque final de tu experiencia.",
                result_thank_you: "¡Gracias por tu contribución!",
                result_follow_steps: "Sigue estos 2 pasos:",
                result_step1: "1. Haz clic en 'Copiar texto'.",
                result_step2: "2. Haz clic en 'Publicar en Google' y pega tu reseña.",
                copy_button: "Copiar texto",
                publish_on_google: "Publicar en Google",
                publish_on_tripadvisor: "Publicar en TripAdvisor",
                loading_restaurant: "Cargando...",
                nav_next: "Siguiente",
                nav_back: "Anterior",
                nav_generate: "Generar mi reseña",
                limit_reached: (limit) => `Límite de ${limit} opciones alcanzado.`,
                api_key_error: "Error: La clave API no está configurada. Por favor, contacta al propietario del sitio."
            },
            pt: {
                lang_name_native: "🇵🇹 Português",
                lang_title: "Escolha o seu idioma",
                server_title: "Quem o atendeu?",
                service_subtitle: "O que você apreciou particularmente? (máx. 3)",
                occasion_title: "Uma ocasião especial?",
                flavors_title: "Os sabores que se destacaram",
                flavors_subtitle: "Escolha até 6 dos seus favoritos.",
                atmosphere_title: "A atmosfera do local",
                atmosphere_subtitle: "Selecione até 3 opções.",
                feedback_title: "Alguma sugestão privada?",
                feedback_subtitle: "Esta mensagem será enviada apenas para a equipe (opcional).",
                generating_title: "A criar a sua avaliação...",
                generating_subtitle: "A nossa IA está a personalizar a sua experiência.",
                result_title: "Uma noite memorável?",
                result_subtitle: "A sua avaliação é o toque final da sua experiência.",
                result_thank_you: "Obrigado pela sua contribuição!",
                result_follow_steps: "Siga estes 2 passos:",
                result_step1: "1. Clique em 'Copiar texto'.",
                result_step2: "2. Clique em 'Publicar no Google' e cole a sua avaliação.",
                copy_button: "Copiar texto",
                publish_on_google: "Publicar no Google",
                publish_on_tripadvisor: "Publicar no TripAdvisor",
                loading_restaurant: "A carregar...",
                nav_next: "Seguinte",
                nav_back: "Anterior",
                nav_generate: "Gerar minha avaliação",
                limit_reached: (limit) => `Limite de ${limit} escolhas atingido.`,
                api_key_error: "Erro: A chave da API não está configurada. Por favor, entre em contato com o proprietário do site."
            },
            it: {
                lang_name_native: "🇮🇹 Italiano",
                lang_title: "Scegli la tua lingua",
                server_title: "Chi ti ha servito?",
                service_subtitle: "Cosa hai apprezzato in particolare? (massimo 3)",
                occasion_title: "Un'occasione speciale?",
                flavors_title: "I sapori che ti hanno colpito",
                flavors_subtitle: "Scegli fino a 6 dei tuoi preferiti.",
                atmosphere_title: "L'atmosfera del locale",
                atmosphere_subtitle: "Seleziona fino a 3 opzioni.",
                feedback_title: "Un suggerimento privato?",
                feedback_subtitle: "Questo messaggio sarà inviato solo al team (opzionale).",
                generating_title: "Creazione della tua recensione...",
                generating_subtitle: "La nostra IA sta personalizzando la tua esperienza.",
                result_title: "Una serata memorabile?",
                result_subtitle: "La tua recensione è il tocco finale della tua esperienza.",
                result_thank_you: "Grazie per il tuo contributo!",
                result_follow_steps: "Segui questi 2 passaggi:",
                result_step1: "1. Clicca su 'Copia il testo'.",
                result_step2: "2. Clicca su 'Pubblica su Google' e incolla la tua recensione.",
                copy_button: "Copia il testo",
                publish_on_google: "Pubblica su Google",
                publish_on_tripadvisor: "Pubblica su TripAdvisor",
                loading_restaurant: "Caricamento...",
                nav_next: "Avanti",
                nav_back: "Indietro",
                nav_generate: "Genera la mia recensione",
                limit_reached: (limit) => `Limite di ${limit} scelte raggiunto.`,
                api_key_error: "Errore: La chiave API non è configurata. Si prega di contattare il proprietario del sito."
            },
            zh: {
                lang_name_native: "🇨🇳 简体中文",
                lang_title: "选择您的语言",
                server_title: "是谁为您服务的？",
                service_subtitle: "您特别欣赏什么？ (最多3个)",
                occasion_title: "一个特殊的场合？",
                flavors_title: "让您印象深刻的风味",
                flavors_subtitle: "选择最多6个您的最爱。",
                atmosphere_title: "餐厅的氛围",
                atmosphere_subtitle: "选择最多3个选项。",
                feedback_title: "有私人建议吗？",
                feedback_subtitle: "此消息将仅发送给团队（可选）。",
                generating_title: "正在生成您的评论...",
                generating_subtitle: "我们的人工智能正在为您个性化体验。",
                result_title: "一个难忘的夜晚？",
                result_subtitle: "您的评论是您体验的点睛之笔。",
                result_thank_you: "感谢您的贡献！",
                result_follow_steps: "请按照以下2个步骤操作：",
                result_step1: "1. 点击“复制文本”。",
                result_step2: "2. 点击“在谷歌上发布”并粘贴您的评论。",
                copy_button: "复制文本",
                publish_on_google: "在谷歌上发布",
                publish_on_tripadvisor: "在TripAdvisor上发布",
                loading_restaurant: "加载中...",
                nav_next: "下一步",
                nav_back: "上一步",
                nav_generate: "生成我的评论",
                limit_reached: (limit) => `已达到${limit}个选择上限。`,
                api_key_error: "错误：API密钥未配置。请联系网站所有者。"
            }
        };

        function getTranslation(key, ...args) {
            const langPack = translations[reviewData.lang] || translations.fr;
            const translation = langPack[key] || key;
            return typeof translation === 'function' ? translation(...args) : translation;
        }

        function renderTagLabels(lang) {
            document.querySelectorAll('.tag-group label').forEach(label => {
                const key = label.getAttribute('for');
                const category = label.closest('.form-section').id.replace('section-', '');
                const tagData = restaurantData.tags?.[category]?.find(t => `tag_${category}_${t.key}` === key);
                if (tagData) {
                    // Utilise la traduction pour la langue sélectionnée, ou le français par défaut si elle n'existe pas.
                    // Ceci s'applique aux tags pré-traduits comme 'occasion' et 'atmosphère'.
                    label.innerText = tagData.translations[lang] || tagData.translations.fr;
                }
            });
        }

        function translatePage() {
            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.dataset.translateKey;
                if (!el.classList.contains('js-no-translate-overwrite')) {
                    el.innerHTML = getTranslation(key);
                }
            });
            nextBtn.innerText = getTranslation('nav_next');
            backBtn.innerText = getTranslation('nav_back');
            renderTagLabels(reviewData.lang);
        }

        async function fetchRestaurantData() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const slug = urlParams.get('slug');
                if (!slug) throw new Error("Identifiant (slug) du restaurant manquant dans l'URL.");
                
                const response = await fetch(`${API_BASE_URL}/api/public/restaurant/${slug}`);
                if (!response.ok) throw new Error(`Restaurant non trouvé ou erreur serveur (code: ${response.status})`);
                
                const data = await response.json();
                restaurantData = { ...data, servers: data.servers || [], languages: data.languages || ['fr', 'en'], tags: data.tags || {} };
                
                const menuResponse = await fetch(`${API_BASE_URL}/api/public/menu/${slug}`);
                if (menuResponse.ok) {
                    restaurantData.menu = await menuResponse.json();
                } else {
                    console.warn(`Could not fetch menu (status: ${menuResponse.status}). The flavor section will be empty.`);
                    restaurantData.menu = {};
                }

                reviewData.lang = restaurantData.languages.includes('fr') ? 'fr' : restaurantData.languages[0];
                return true;
            } catch (error) {
                reviewContainer.innerHTML = `<div class="text-center p-8">
                    <h2 class="font-serif text-2xl font-bold text-red-600">Erreur de Chargement</h2>
                    <p class="mt-4 text-gray-700">Impossible de charger la page d'avis.</p>
                    <p class="mt-2 text-sm text-gray-500"><b>Détail :</b> ${error.message}</p>
                    <p class="mt-6 text-sm text-gray-500">Veuillez vérifier que le lien (URL) que vous avez utilisé est correct et complet.</p>
                </div>`;
                return false;
            }
        }

        function applyBranding() {
            const root = document.documentElement;
            const color = restaurantData.primaryColor || '#D69E2E';
            root.style.setProperty('--color-primary', color);
            
            if (/^#([0-9A-F]{3}){1,2}$/i.test(color)) {
                const hex = color.substring(1);
                const isShort = hex.length === 3;
                const rHex = isShort ? hex[0] + hex[0] : hex.substring(0, 2);
                const gHex = isShort ? hex[1] + hex[1] : hex.substring(2, 4);
                const bHex = isShort ? hex[2] + hex[2] : hex.substring(4, 6);
                const [r, g, b] = [parseInt(rHex, 16), parseInt(gHex, 16), parseInt(bHex, 16)];
                
                root.style.setProperty('--color-primary-dark', `rgb(${Math.max(0, r-20)}, ${Math.max(0, g-20)}, ${Math.max(0, b-20)})`);
            }

            document.title = `Avis - ${restaurantData.name}`;
            const logoUrl = restaurantData.logoUrl ? `${API_BASE_URL}${restaurantData.logoUrl}` : `https://placehold.co/200x60/${color.substring(1)}/FFFFFF?text